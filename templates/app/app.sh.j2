#!/usr/bin/env bash

SUDO={{ bin_sudo }}
DOCKER={{ bin_docker }}

function init(){
    ${SUDO} ${DOCKER} stack deploy --compose-file docker-compose.yml app
}

function build() {
    ${SUDO} ${DOCKER} pull scce/dywa:latest && \
    ${SUDO} ${DOCKER} build -t scce/webapp -f src/Dockerfile-webapp src && \
    ${SUDO} ${DOCKER} build -t scce/dywa-app -f src/Dockerfile-dywa-app src
}

function migrate() {
    ${SUDO} ${DOCKER} service scale app_dywa-app=0 && \
    ${DOCKER} run --rm \
            --network=app_postgres \
            -v="/home/dime/app/maven:/root/.m2" \
            -v="/home/dime/app/src/dywa-app:/usr/src/mymaven" \
            -w="/usr/src/mymaven/app-dywa-bridge" \
            maven:3.5.4 mvn package -Dde.ls5.dywa.jdbc-connection-url=jdbc:postgresql://{{ dywa_database_host }}:5432/dywa -Dde.ls5.dywa.jdbc-user={{ dywa_database_user }} -Dde.ls5.dywa.jdbc-user={{ dywa_database_password }} -Dhibernate.dialect=org.hibernate.dialect.PostgreSQLDialect && \
    ${SUDO} chown -R {{ deploy_user }}:{{ deploy_user }} /home/dime/app/maven/repository
}

function restart() {
    ${SUDO} ${DOCKER} service update --force app_webapp && \
    ${SUDO} ${DOCKER} service scale app_dywa-app=1 && \
    ${SUDO} ${DOCKER} service update --force app_dywa-app
}

function deploy() {
    migrate
    build
    restart
}

case "$1" in
    "--init")
    init
    ;;
    "--build")
    build
    ;;
    "--migrate")
    migrate
    ;;
    "--restart")
    restart
    ;;
    "--deploy")
    deploy
    ;;
    *)
    echo "Please specify the mode: [\"--init\", \"--build\", \"--migrate\", \"--restart\", \"--deploy\"]"
    exit 0
    ;;
esac
