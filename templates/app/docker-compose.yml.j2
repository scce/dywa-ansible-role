version: '3.2'

networks:
  dywa-app:
{% if deployment_tier != 'production' %}
  mailcatcher:
{% endif %}
  postgres:
    attachable: true
  webapp:

volumes:
  wildfly:
  postgres:

services:
  webapp:
    image: scce/webapp:latest
    deploy:
        replicas: 0
    networks:
      - webapp
    volumes:
      - "./config/webapp/nginx.conf:/etc/nginx/nginx.conf:ro"
    ports:
      - "3000:80"
  dywa-app:
    environment:
      - "CLIENT_ORIGIN=https://{{ domain }}"
    depends_on:
      - postgres
    networks:
      - dywa-app
      - postgres
{% if deployment_tier != 'production' %}
      - mailcatcher
{% endif %}
    image: scce/dywa-app:latest
    deploy:
        replicas: 0
    volumes:
      - "./config/dywa-app/standalone.xml:/opt/jboss/wildfly/standalone/configuration/standalone.xml:ro"
      - "./config/dywa-app/standalone.conf:/opt/jboss/wildfly/bin/standalone.conf:ro"
      - "wildfly:/opt/jboss/wildfly/standalone/data/files"
    ports:
      - "8080:8080"
  postgres:
    environment:
      - "POSTGRES_DB=dywa"
      - "POSTGRES_PASSWORD={{ dywa_database_password }}"
      - "POSTGRES_USER={{ dywa_database_user }}"
    image: scce/dywa-postgres:latest
    deploy:
        replicas: 1
    networks:
      - postgres
    volumes:
      - "postgres:/var/lib/postgresql/data"
{% if deployment_tier != 'production' %}
  mailcatcher:
    image: scce/mailcatcher:latest
    deploy:
        replicas: 1
    networks:
      - mailcatcher
    ports:
      - "1080:1080"
{% endif %}
