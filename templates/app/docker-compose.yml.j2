version: '3.2'

networks:
  dywa-app:
{% if deployment_tier != 'production' %}
  mailcatcher:
{% endif %}
  postgres:
    attachable: true
  webapp:

volumes:
  wildfly:
  postgres:

services:
  nginx:
    image: nginx:{{ nginx_version }}
    deploy:
      replicas: 0
    networks:
      - dywa-app
{% if deployment_tier != 'production' %}
      - mailcatcher
{% endif %}
      - webapp
    depends_on:
      - dywa-app
{% if deployment_tier != 'production' %}
      - mailcatcher
{% endif %}
      - webapp
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "./config/nginx/conf.d/dywa-app.conf:/etc/nginx/conf.d/dywa-app.conf:ro"
      - "./config/nginx/conf.d/ssl.conf:/etc/nginx/conf.d/ssl.conf:ro"
      - "./config/nginx/conf.d/webapp.conf:/etc/nginx/conf.d/webapp.conf:ro"
      - "./config/nginx/htpasswd-dywa:/etc/nginx/htpasswd-dywa:ro"
{% if deployment_tier != 'production' %}
      - "./config/nginx/htpasswd-mailcatcher:/etc/nginx/htpasswd-mailcatcher:ro"
{% endif %}
      - "./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "/etc/letsencrypt:/etc/letsencrypt:ro"
      - "/var/www/certbot:/var/www/certbot:ro"
  webapp:
    image: scce/webapp:latest
    deploy:
        replicas: 0
    networks:
      - webapp
    volumes:
      - "./config/webapp/nginx.conf:/etc/nginx/nginx.conf:ro"
  dywa-app:
    environment:
      - "CLIENT_ORIGIN=https://{{ domain }}"
    depends_on:
      - postgres
    networks:
      - dywa-app
      - postgres
{% if deployment_tier != 'production' %}
      - mailcatcher
{% endif %}
    image: scce/dywa-app:latest
    deploy:
        replicas: 0
    volumes:
      - "./config/dywa-app/standalone.xml:/opt/jboss/wildfly/standalone/configuration/standalone.xml:ro"
      - "wildfly:/opt/jboss/wildfly/standalone/data/files"
  postgres:
    environment:
      - "POSTGRES_DB=dywa"
      - "POSTGRES_PASSWORD={{ dywa_database_password }}"
      - "POSTGRES_USER={{ dywa_database_user }}"
    image: scce/dywa-postgres:latest
    deploy:
        replicas: 1
    networks:
      - postgres
    volumes:
      - "postgres:/var/lib/postgresql/data"
{% if deployment_tier != 'production' %}
  mailcatcher:
    image: scce/mailcatcher:latest
    deploy:
        replicas: 1
    networks:
      - mailcatcher
{% endif %}
